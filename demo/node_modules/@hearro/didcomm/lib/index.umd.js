!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("base-58"),require("libsodium-wrappers")):"function"==typeof define&&define.amd?define(["exports","base-58","libsodium-wrappers"],t):t(e.didcommJs={},e.Base58,e.sodium)}(this,function(e,t,r){function i(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}r=r&&r.hasOwnProperty("default")?r.default:r,"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var o=function(){var e=this;this.ready=new Promise(function(t,o){try{var n=i(function(){return Promise.resolve(r.ready).then(function(){e.sodium=r,t()})},function(e){o(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})};o.prototype.generateKeyPair=function(){try{return Promise.resolve(this.sodium.crypto_sign_keypair())}catch(e){return Promise.reject(e)}},o.prototype.pack_auth_msg_for_recipients=function(e,t,r,i){void 0===i&&(i=!1);try{var o=this;return i?Promise.resolve(o.signContent(e,r)).then(function(e){return o.packMessage(e,t,r)}):Promise.resolve(o.packMessage(e,t,r))}catch(e){return Promise.reject(e)}},o.prototype.pack_anon_msg_for_recipients=function(e,t){try{return Promise.resolve(this.packMessage(e,t,null))}catch(e){return Promise.reject(e)}},o.prototype.pack_nonrepudiable_msg_for_anyone=function(e,t){try{return Promise.resolve(this.signContent(e,t))}catch(e){return Promise.reject(e)}},o.prototype.unpackMessage=function(e,t){try{var r=this;return Promise.resolve(i(function(){return Promise.resolve(r.unpackEncrypted(e,t))},function(){var t=r.verifyContent(e);return{message:t.content,recipientKey:null,senderKey:t.verkey,nonRepudiableVerification:t.verified}}))}catch(e){return Promise.reject(e)}},o.prototype.packMessage=function(e,t,r){void 0===r&&(r=null);try{var i=this.prepareRecipientKeys(t,r),o=i[1],n=this.b64url(i[0]),s=this.encryptPlaintext(e,n,o),c=s[1],a=s[2];return Promise.resolve(JSON.stringify({ciphertext:this.b64url(s[0]),iv:this.b64url(a),protected:n,tag:this.b64url(c)}))}catch(e){return Promise.reject(e)}},o.prototype.unpackEncrypted=function(e,r){try{var i;i="string"==typeof e?JSON.parse(e):e,"string"==typeof r.publicKey&&(r.publicKey=t.decode(r.publicKey)),"string"==typeof r.privateKey&&(r.privateKey=t.decode(r.privateKey));var o=this.strB64dec(i.protected),n=JSON.parse(o),s=n.alg,c="Authcrypt"===s;if(!c&&"Anoncrypt"!==s)throw new Error("Unsupported pack algorithm: "+s);var a=this.locateRecKey(n.recipients,r),u=a[0],p=a[1],d=a[2];if(!p&&c)throw new Error("Sender public key not provided in Authcrypt message");var y=this.b64dec(i.ciphertext),h=this.b64dec(i.iv),l=this.b64dec(i.tag),_=this.decryptPlaintext(y,l,i.protected,h,u);try{var m=this.verifyContent(_);return Promise.resolve({message:m.content,recipientKey:d,senderKey:p,nonRepudiableVerification:p===m.verkey})}catch(e){return Promise.resolve({message:_,recipientKey:d,senderKey:p,nonRepudiableVerification:!1})}return Promise.resolve()}catch(e){return Promise.reject(e)}},o.prototype.signContent=function(e,i){try{var o=t.encode(i.publicKey),n=JSON.stringify({alg:"EdDSA",kid:o}),s=this.b64url(n)+"."+this.b64url(e),c=this.b64url(r.crypto_sign(s,i.privateKey));return Promise.resolve(s+"."+c)}catch(e){return Promise.reject(e)}},o.prototype.verifyContent=function(e){var i=e.split("."),o=JSON.parse(this.strB64dec(i[0]));if("EdDSA"!=o.alg)throw"Cryptographic algorithm unidentifiable";var n=r.crypto_sign_open(this.b64dec(i[2]),t.decode(o.kid));return{content:this.strB64dec(i[1]),verkey:o.kid,verified:r.to_string(n)===i[0]+"."+i[1]}},o.prototype.b64url=function(e){return this.sodium.to_base64(e,this.sodium.base64_variants.URLSAFE)},o.prototype.b64dec=function(e){return this.sodium.from_base64(e,this.sodium.base64_variants.URLSAFE)},o.prototype.strB64dec=function(e){return this.sodium.to_string(this.sodium.from_base64(e,this.sodium.base64_variants.URLSAFE))},o.prototype.encryptPlaintext=function(e,t,r){var i=this.sodium.randombytes_buf(this.sodium.crypto_aead_chacha20poly1305_ietf_NPUBBYTES),o=this.sodium.crypto_aead_chacha20poly1305_ietf_encrypt_detached(e,t,null,i,r);return[o.ciphertext,o.mac,i]},o.prototype.decryptPlaintext=function(e,t,r,i,o){return this.sodium.to_string(this.sodium.crypto_aead_chacha20poly1305_ietf_decrypt_detached(null,e,t,r,i,o))},o.prototype.prepareRecipientKeys=function(e,r){var i=this;void 0===r&&(r=null);var o=this.sodium.crypto_aead_chacha20poly1305_ietf_keygen(),n=[];return e.forEach(function(e){var s=null,c=null,a=null,u=i.sodium.crypto_sign_ed25519_pk_to_curve25519(e);if(r){var p=t.encode(r.publicKey),d=i.sodium.crypto_sign_ed25519_sk_to_curve25519(r.privateKey);c=i.sodium.crypto_box_seal(p,u),a=i.sodium.randombytes_buf(i.sodium.crypto_box_NONCEBYTES),s=i.sodium.crypto_box_easy(o,a,u,d)}else s=i.sodium.crypto_box_seal(o,u);n.push({encrypted_key:i.b64url(s),header:{iv:a?i.b64url(a):null,kid:t.encode(e),sender:c?i.b64url(c):null}})}),[JSON.stringify({alg:r?"Authcrypt":"Anoncrypt",enc:"chacha20poly1305_ietf",recipients:n,typ:"JWM/1.0"}),o]},o.prototype.locateRecKey=function(e,r){for(var i in e){var o=e[i];if(!("header"in o&&"encrypted_key"in o))throw new Error("Invalid recipient header");var n=t.decode(o.header.kid);this.sodium.memcmp(n,r.publicKey);var s=this.sodium.crypto_sign_ed25519_pk_to_curve25519(r.publicKey),c=this.sodium.crypto_sign_ed25519_sk_to_curve25519(r.privateKey),a=this.b64dec(o.encrypted_key),u=o.header.iv?this.b64dec(o.header.iv):null,p=o.header.sender?this.b64dec(o.header.sender):null,d=null,y=null;if(u&&p){d=this.sodium.to_string(this.sodium.crypto_box_seal_open(p,s,c));var h=this.sodium.crypto_sign_ed25519_pk_to_curve25519(t.decode(d));y=this.sodium.crypto_box_open_easy(a,u,h,c)}else y=this.sodium.crypto_box_seal_open(a,s,c);return[y,d,o.header.kid]}throw new Error("No corresponding recipient key found in recipients")},e.DIDComm=o});
//# sourceMappingURL=index.umd.js.map
