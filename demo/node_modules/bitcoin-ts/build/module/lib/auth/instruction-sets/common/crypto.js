import { ConsensusBCH } from '../bch/bch-types';
import { serializeAuthenticationInstructions } from '../instruction-sets-utils';
import { combineOperations, pushToStack, useOneScriptNumber, useOneStackItem, useTwoStackItems, } from './combinators';
import { booleanToScriptNumber, ConsensusCommon } from './common';
import { decodeBitcoinSignature, isValidPublicKeyEncoding, isValidSignatureEncodingBCHTransaction, } from './encoding';
import { applyError, AuthenticationErrorCommon } from './errors';
import { opVerify } from './flow-control';
import { OpcodesCommon } from './opcodes';
import { generateSigningSerializationBCH } from './signing-serialization';
export const opRipemd160 = ({ ripemd160, }) => (state) => useOneStackItem(state, (nextState, [value]) => pushToStack(nextState, ripemd160.hash(value)));
export const opSha1 = ({ sha1, }) => (state) => useOneStackItem(state, (nextState, [value]) => pushToStack(nextState, sha1.hash(value)));
export const opSha256 = ({ sha256, }) => (state) => useOneStackItem(state, (nextState, [value]) => pushToStack(nextState, sha256.hash(value)));
export const opHash160 = ({ ripemd160, sha256, }) => (state) => useOneStackItem(state, (nextState, [value]) => pushToStack(nextState, ripemd160.hash(sha256.hash(value))));
export const opHash256 = ({ sha256, }) => (state) => useOneStackItem(state, (nextState, [value]) => pushToStack(nextState, sha256.hash(sha256.hash(value))));
export const opCodeSeparator = () => (state) => {
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.lastCodeSeparator = state.ip;
    return state;
};
export const opCheckSig = ({ flags, secp256k1, sha256, }) => (s) => 
// eslint-disable-next-line complexity
useTwoStackItems(s, (state, [bitcoinEncodedSignature, publicKey]) => {
    if (!isValidPublicKeyEncoding(publicKey)) {
        return applyError(AuthenticationErrorCommon.invalidPublicKeyEncoding, state);
    }
    if (!isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
        return applyError(AuthenticationErrorCommon.invalidSignatureEncoding, state);
    }
    const coveredBytecode = serializeAuthenticationInstructions(state.instructions).subarray(state.lastCodeSeparator + 1);
    const { signingSerializationType, signature } = decodeBitcoinSignature(bitcoinEncodedSignature);
    const serialization = generateSigningSerializationBCH({
        correspondingOutput: state.correspondingOutput,
        coveredBytecode,
        locktime: state.locktime,
        outpointIndex: state.outpointIndex,
        outpointTransactionHash: state.outpointTransactionHash,
        outputValue: state.outputValue,
        sequenceNumber: state.sequenceNumber,
        sha256,
        signingSerializationType,
        transactionOutpoints: state.transactionOutpoints,
        transactionOutputs: state.transactionOutputs,
        transactionSequenceNumbers: state.transactionSequenceNumbers,
        version: state.version,
    });
    const digest = sha256.hash(sha256.hash(serialization));
    const useSchnorr = signature.length === ConsensusBCH.schnorrSignatureLength;
    const success = useSchnorr
        ? secp256k1.verifySignatureSchnorr(signature, publicKey, digest)
        : secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
    return !success &&
        flags.requireNullSignatureFailures &&
        signature.length !== 0
        ? applyError(AuthenticationErrorCommon.nonNullSignatureFailure, state)
        : pushToStack(state, booleanToScriptNumber(success));
});
export const opCheckMultiSig = ({ flags: { requireMinimalEncoding, requireBugValueZero, requireNullSignatureFailures, }, secp256k1, sha256, }) => (s) => useOneScriptNumber(s, (state, publicKeysValue) => {
    const potentialPublicKeys = Number(publicKeysValue);
    if (potentialPublicKeys < 0) {
        return applyError(AuthenticationErrorCommon.invalidNaturalNumber, state);
    }
    if (potentialPublicKeys > 20 /* maximumPublicKeys */) {
        return applyError(AuthenticationErrorCommon.exceedsMaximumMultisigPublicKeyCount, state);
    }
    const publicKeys = 
    // eslint-disable-next-line functional/immutable-data
    potentialPublicKeys > 0 ? state.stack.splice(-potentialPublicKeys) : [];
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.operationCount += potentialPublicKeys;
    return state.operationCount > ConsensusCommon.maximumOperationCount
        ? applyError(AuthenticationErrorCommon.exceededMaximumOperationCount, state)
        : useOneScriptNumber(state, (nextState, approvingKeys) => {
            const requiredApprovingPublicKeys = Number(approvingKeys);
            if (requiredApprovingPublicKeys < 0) {
                return applyError(AuthenticationErrorCommon.invalidNaturalNumber, nextState);
            }
            if (requiredApprovingPublicKeys > potentialPublicKeys) {
                return applyError(AuthenticationErrorCommon.insufficientPublicKeys, nextState);
            }
            const signatures = requiredApprovingPublicKeys > 0
                ? // eslint-disable-next-line functional/immutable-data
                    nextState.stack.splice(-requiredApprovingPublicKeys)
                : [];
            return useOneStackItem(nextState, 
            // eslint-disable-next-line complexity
            (finalState, [protocolBugValue]) => {
                if (requireBugValueZero && protocolBugValue.length !== 0) {
                    return applyError(AuthenticationErrorCommon.invalidProtocolBugValue, finalState);
                }
                const coveredBytecode = serializeAuthenticationInstructions(finalState.instructions).subarray(finalState.lastCodeSeparator + 1);
                let approvingPublicKeys = 0; // eslint-disable-line functional/no-let
                let remainingSignatures = signatures.length; // eslint-disable-line functional/no-let
                let remainingPublicKeys = publicKeys.length; // eslint-disable-line functional/no-let
                // eslint-disable-next-line functional/no-loop-statement
                while (remainingSignatures > 0 &&
                    remainingPublicKeys > 0 &&
                    approvingPublicKeys + remainingPublicKeys >=
                        remainingSignatures &&
                    approvingPublicKeys !== requiredApprovingPublicKeys) {
                    const publicKey = publicKeys[remainingPublicKeys - 1];
                    const bitcoinEncodedSignature = signatures[remainingSignatures - 1];
                    if (!isValidPublicKeyEncoding(publicKey)) {
                        return applyError(AuthenticationErrorCommon.invalidPublicKeyEncoding, finalState);
                    }
                    if (!isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
                        return applyError(AuthenticationErrorCommon.invalidSignatureEncoding, finalState);
                    }
                    const { signingSerializationType, signature, } = decodeBitcoinSignature(bitcoinEncodedSignature);
                    const serialization = generateSigningSerializationBCH({
                        correspondingOutput: state.correspondingOutput,
                        coveredBytecode,
                        locktime: state.locktime,
                        outpointIndex: state.outpointIndex,
                        outpointTransactionHash: state.outpointTransactionHash,
                        outputValue: state.outputValue,
                        sequenceNumber: state.sequenceNumber,
                        sha256,
                        signingSerializationType,
                        transactionOutpoints: state.transactionOutpoints,
                        transactionOutputs: state.transactionOutputs,
                        transactionSequenceNumbers: state.transactionSequenceNumbers,
                        version: state.version,
                    });
                    const digest = sha256.hash(sha256.hash(serialization));
                    if (signature.length === ConsensusBCH.schnorrSignatureLength) {
                        return applyError(AuthenticationErrorCommon.schnorrSizedSignatureInCheckMultiSig, finalState);
                    }
                    const signed = secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
                    // eslint-disable-next-line functional/no-conditional-statement
                    if (signed) {
                        approvingPublicKeys += 1; // eslint-disable-line functional/no-expression-statement
                        remainingSignatures -= 1; // eslint-disable-line functional/no-expression-statement
                    }
                    remainingPublicKeys -= 1; // eslint-disable-line functional/no-expression-statement
                }
                const success = approvingPublicKeys === requiredApprovingPublicKeys;
                if (!success &&
                    requireNullSignatureFailures &&
                    !signatures.every((signature) => signature.length === 0)) {
                    return applyError(AuthenticationErrorCommon.nonNullSignatureFailure, finalState);
                }
                return pushToStack(finalState, booleanToScriptNumber(success));
            });
        }, { requireMinimalEncoding });
}, { requireMinimalEncoding });
export const opCheckSigVerify = ({ flags, secp256k1, sha256, }) => combineOperations(opCheckSig({ flags, secp256k1, sha256 }), opVerify());
export const opCheckMultiSigVerify = ({ flags, secp256k1, sha256, }) => combineOperations(opCheckMultiSig({ flags, secp256k1, sha256 }), opVerify());
export const cryptoOperations = ({ flags, ripemd160, secp256k1, sha1, sha256, }) => ({
    [OpcodesCommon.OP_RIPEMD160]: opRipemd160({
        ripemd160,
    }),
    [OpcodesCommon.OP_SHA1]: opSha1({ sha1 }),
    [OpcodesCommon.OP_SHA256]: opSha256({ sha256 }),
    [OpcodesCommon.OP_HASH160]: opHash160({
        ripemd160,
        sha256,
    }),
    [OpcodesCommon.OP_HASH256]: opHash256({ sha256 }),
    [OpcodesCommon.OP_CODESEPARATOR]: opCodeSeparator(),
    [OpcodesCommon.OP_CHECKSIG]: opCheckSig({
        flags,
        secp256k1,
        sha256,
    }),
    [OpcodesCommon.OP_CHECKSIGVERIFY]: opCheckSigVerify({
        flags,
        secp256k1,
        sha256,
    }),
    [OpcodesCommon.OP_CHECKMULTISIG]: opCheckMultiSig({
        flags,
        secp256k1,
        sha256,
    }),
    [OpcodesCommon.OP_CHECKMULTISIGVERIFY]: opCheckMultiSigVerify({ flags, secp256k1, sha256 }),
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9hdXRoL2luc3RydWN0aW9uLXNldHMvY29tbW9uL2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLG1DQUFtQyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFaEYsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixXQUFXLEVBQ1gsa0JBQWtCLEVBQ2xCLGVBQWUsRUFDZixnQkFBZ0IsR0FDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLHFCQUFxQixFQUFFLGVBQWUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsRSxPQUFPLEVBQ0wsc0JBQXNCLEVBQ3RCLHdCQUF3QixFQUN4QixzQ0FBc0MsR0FDdkMsTUFBTSxZQUFZLENBQUM7QUFDcEIsT0FBTyxFQUFFLFVBQVUsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNqRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMxQyxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUkxRSxNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FJekIsRUFDQSxTQUFTLEdBR1YsRUFBb0IsRUFBRSxDQUFDLENBQUMsS0FBWSxFQUFFLEVBQUUsQ0FDdkMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FDNUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQzlDLENBQUM7QUFFSixNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsQ0FJcEIsRUFDQSxJ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