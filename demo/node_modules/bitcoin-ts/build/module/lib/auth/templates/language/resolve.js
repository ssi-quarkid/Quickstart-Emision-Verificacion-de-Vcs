import { hexToBin, utf8ToBin } from '../../../format/format';
import { dateToLocktime } from '../../../format/time';
import { bigIntToScriptNumber } from '../../instruction-sets/instruction-sets';
import { compileScript } from './compile';
const pluckRange = (node) => ({
    endColumn: node.end.column,
    endLineNumber: node.end.line,
    startColumn: node.start.column,
    startLineNumber: node.start.line,
});
export var IdentifierResolutionType;
(function (IdentifierResolutionType) {
    IdentifierResolutionType["opcode"] = "opcode";
    IdentifierResolutionType["variable"] = "variable";
    IdentifierResolutionType["script"] = "script";
})(IdentifierResolutionType || (IdentifierResolutionType = {}));
var Constants;
(function (Constants) {
    Constants[Constants["hexByte"] = 2] = "hexByte";
})(Constants || (Constants = {}));
export const resolveScriptSegment = (segment, resolveIdentifiers) => {
    // eslint-disable-next-line complexity
    const resolved = segment.value.map((child) => {
        const range = pluckRange(child);
        switch (child.name) {
            case 'Identifier': {
                const identifier = child.value;
                const result = resolveIdentifiers(identifier);
                const ret = result.status
                    ? {
                        range,
                        type: 'bytecode',
                        value: result.bytecode,
                        ...(result.type === IdentifierResolutionType.opcode
                            ? {
                                opcode: identifier,
                            }
                            : result.type === IdentifierResolutionType.variable
                                ? {
                                    variable: identifier,
                                }
                                : // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
                                    result.type === IdentifierResolutionType.script
                                        ? { script: identifier, source: result.source }
                                        : { unknown: identifier }),
                    }
                    : {
                        range,
                        type: 'error',
                        value: result.error,
                    };
                return ret;
            }
            case 'Push':
                return {
                    range,
                    type: 'push',
                    value: resolveScriptSegment(child.value, resolveIdentifiers),
                };
            case 'Evaluation':
                return {
                    range,
                    type: 'evaluation',
                    value: resolveScriptSegment(child.value, resolveIdentifiers),
                };
            case 'BigIntLiteral':
                return {
                    literalType: 'BigIntLiteral',
                    range,
                    type: 'bytecode',
                    value: bigIntToScriptNumber(child.value),
                };
            case 'HexLiteral':
                return child.value.length % Constants.hexByte === 0
                    ? {
                        literalType: 'HexLiteral',
                        range,
                        type: 'bytecode',
                        value: hexToBin(child.value),
                    }
                    : {
                        range,
                        type: 'error',
                        value: `Improperly formed HexLiteral. HexLiteral must have a length divisible by 2, but this HexLiteral has a length of ${child.value.length}.`,
                    };
            case 'UTF8Literal':
                return {
                    literalType: 'UTF8Literal',
                    range,
                    type: 'bytecode',
                    value: utf8ToBin(child.value),
                };
            case 'Comment':
                return {
                    range,
                    type: 'comment',
                    value: child.value,
                };
            default:
                return {
                    range,
                    type: 'error',
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    value: `Unrecognized segment: ${child.name}`,
                };
        }
    });
    return resolved.length === 0
        ? [{ range: pluckRange(segment), type: 'comment', value: '' }]
        : resolved;
};
const articleAndVariableType = (variableType) => `${variableType === 'HDKey' ? 'an' : 'a'} ${variableType}`;
const attemptCompilerOperation = ({ data, environment, identifier, operationId, variableType, }) => {
    if (environment.operations !== undefined) {
        const operationsForType = environment.operations[variableType];
        if (operationsForType !== undefined) {
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            const operation = operationsForType[operationId];
            if (operation !== undefined) {
                return operation(identifier, data, environment);
            }
        }
    }
    return `Identifer "${identifier}" refers to ${articleAndVariableType(variableType)} operation "${operationId}" which is not available to this compiler.`;
};
const variableTypeToDataProperty = {
    AddressData: 'addressData',
    HDKey: 'hdKeys',
    Key: 'keys',
    WalletData: 'walletData',
};
const defaultActionByVariableType = {
    AddressData: (identifier, data, variableId) => data.addressData !== undefined &&
        data.addressData[variableId] !== undefined
        ? data.addressData[variableId]
        : `Identifier "${identifier}" refers to an AddressData, but no AddressData for "${variableId}" were provided in the compilation data.`,
    HDKey: (identifier) => `Identifier "${identifier}" refers to an HDKey, but does not specify an operation, e.g. "${identifier}.public_key".`,
    Key: (identifier) => `Identifier "${identifier}" refers to a Key, but does not specify an operation, e.g. "${identifier}.public_key".`,
    WalletData: (identifier, data, variableId) => data.walletData !== undefined &&
        data.walletData[variableId] !== undefined
        ? data.walletData[variableId]
        : `Identifier "${identifier}" refers to a WalletData, but no WalletData for "${variableId}" were provided in the compilation data.`,
};
const aOrAnQuotedString = (word) => `${['a', 'e', 'i', 'o', 'u'].includes(word[0].toLowerCase()) ? 'an' : 'a'} "${word}"`;
export var BuiltInVariables;
(function (BuiltInVariables) {
    BuiltInVariables["currentBlockTime"] = "current_block_time";
    BuiltInVariables["currentBlockHeight"] = "current_block_height";
    BuiltInVariables["signingSerialization"] = "signing_serialization";
})(BuiltInVariables || (BuiltInVariables = {}));
/**
 * If the identifer can be successfully resolved as a variable, the result is
 * returned as a Uint8Array. If the identifier references a known variable, but
 * an error occurs in resolving it, the error is returned as a string.
 * Otherwise, the identifier is not recognized as a variable, and this method
 * simply returns `false`.
 */
// eslint-disable-next-line complexity
export const resolveAuthenticationTemplateVariable = (identifier, environment, data) => {
    const splitId = identifier.split('.');
    const variableId = splitId[0]; // eslint-disable-line prefer-destructuring
    const operationId = splitId[1];
    switch (variableId) {
        case BuiltInVariables.currentBlockHeight:
            return data.currentBlockHeight === undefined
                ? 'Tried to resolve the built-in variable "current_block_height", but the "currentBlockHeight" property was not provided in the compilation data.'
                : bigIntToScriptNumber(BigInt(data.currentBlockHeight));
        case BuiltInVariables.currentBlockTime:
            return data.currentBlockTime === undefined
                ? 'Tried to resolve the built-in variable "current_block_time", but the "currentBlockTime" property was not provided in the compilation data.'
                : dateToLocktime(data.currentBlockTime);
        case BuiltInVariables.signingSerialization:
            return operationId === undefined
                ? 'Tried to resolve an operation for the built-in variable "signing_serialization", but no operation was provided. Provide an operation like "signing_serialization.[operation]".'
                : attemptCompilerOperation({
                    data,
                    environment,
                    identifier,
                    operationId,
                    variableType: 'SigningSerialization',
                });
        default: {
            const selected = environment.variables?.[variableId];
            if (selected === undefined) {
                return false;
            }
            return data[variableTypeToDataProperty[selected.type]] === undefined
                ? `Identifier "${identifier}" is a ${selected.type}, but the compilation data does not include ${aOrAnQuotedString(variableTypeToDataProperty[selected.type])} property.`
                : operationId === undefined
                    ? defaultActionByVariableType[selected.type](identifier, data, variableId)
                    : attemptCompilerOperation({
                        data,
                        environment,
                        identifier,
                        operationId,
                        variableType: selected.type,
                    });
        }
    }
};
/**
 * Compile an internal script identifier.
 *
 * @remarks
 * If the identifer can be successfully resolved as a script, the script is
 * compiled and returned as a CompilationResultSuccess. If an error occurs in
 * compiling it, the error is returned as a string.
 *
 * Otherwise, the identifier is not recognized as a script, and this method
 * simply returns `false`.
 *
 * @param identifier - the identifier of the script to be resolved
 * @param data - the provided CompilationData
 * @param environment - the provided CompilationEnvironment
 * @param parentIdentifier - the identifier of the script which references the
 * script being resolved (for detecting circular dependencies)
 */
// eslint-disable-next-line complexity
export const resolveScriptIdentifier = ({ data, environment, identifier, parentIdentifier, }) => {
    if (environment.scripts[identifier] === undefined) {
        return false;
    }
    if (parentIdentifier !== undefined &&
        environment.sourceScriptIds !== undefined &&
        environment.sourceScriptIds.includes(parentIdentifier)) {
        return `A circular dependency was encountered. Script "${identifier}" relies on itself to be generated. (Parent scripts: ${environment.sourceScriptIds.join(', ')})`;
    }
    const result = compileScript(identifier, data, {
        ...environment,
        sourceScriptIds: [
            ...(environment.sourceScriptIds === undefined
                ? []
                : environment.sourceScriptIds),
            ...(parentIdentifier === undefined ? [] : [parentIdentifier]),
        ],
    });
    return result.success
        ? result
        : `Compilation error in resolved script, ${identifier}: ${result.errors
            .map(({ error, range }) => 
        // tslint:disable-next-line: no-unsafe-any
        `${error} [${range.startLineNumber}, ${range.startColumn}]`)
            .join(', ')}`;
};
/**
 * Return an `IdentifierResolutionFunction` for use in `resolveScriptSegment`.
 *
 * @param scriptId - the `id` of the script for which the resulting
 * `IdentifierResolutionFunction` will be used.
 * @param environment - a snapshot of the context around `scriptId`. See
 * `CompilationEnvironment` for details.
 * @param data - the actual variable values (private keys, shared wallet data,
 * shared address data, etc.) to use in resolving variables.
 */
export const createIdentifierResolver = (scriptId, data, environment) => 
// eslint-disable-next-line complexity
(identifier) => {
    const opcodeResult = environment.opcodes?.[identifier];
    if (opcodeResult !== undefined) {
        return {
            bytecode: opcodeResult,
            status: true,
            type: IdentifierResolutionType.opcode,
        };
    }
    const variableResult = resolveAuthenticationTemplateVariable(identifier, environment, data);
    if (variableResult !== false) {
        return typeof variableResult === 'string'
            ? { error: variableResult, status: false }
            : {
                bytecode: variableResult,
                status: true,
                type: IdentifierResolutionType.variable,
            };
    }
    const scriptResult = resolveScriptIdentifier({
        data,
        environment,
        identifier,
        parentIdentifier: scriptId,
    });
    if (scriptResult !== false) {
        return typeof scriptResult === 'string'
            ? { error: scriptResult, status: false }
            : {
                bytecode: scriptResult.bytecode,
                source: scriptResult.resolve,
                status: true,
                type: IdentifierResolutionType.script,
            };
    }
    return { error: `Unknown identifier '${identifier}'.`, status: false };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvYXV0aC90ZW1wbGF0ZXMvbGFuZ3VhZ2UvcmVzb2x2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzdELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUsvRSxPQUFPLEVBQTRCLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQVVwRSxNQUFNLFVBQVUsR0FBRyxDQUFDLElBQWdCLEVBQVMsRUFBRSxDQUFDLENBQUM7SUFDL0MsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTTtJQUMxQixhQUFhLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJO0lBQzVCLFdBQVcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07SUFDOUIsZUFBZSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtDQUNqQyxDQUFDLENBQUM7QUFvRUgsTUFBTSxDQUFOLElBQVksd0JBSVg7QUFKRCxXQUFZLHdCQUF3QjtJQUNsQyw2Q0FBaUIsQ0FBQTtJQUNqQixpREFBcUIsQ0FBQTtJQUNyQiw2Q0FBaUIsQ0FBQTtBQUNuQixDQUFDLEVBSlcsd0JBQXdCLEtBQXhCLHdCQUF3QixRQUluQztBQWtCRCxJQUFLLFNBRUo7QUFGRCxXQUFLLFNBQVM7SUFDWiwrQ0FBVyxDQUFBO0FBQ2IsQ0FBQyxFQUZJLFNBQVMsS0FBVCxTQUFTLFFBRWI7QUFFRCxNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBRyxDQUNsQyxPQUF5QixFQUN6QixrQkFBZ0QsRUFDaEMsRUFBRTtJQUNsQixzQ0FBc0M7SUFDdEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUss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