"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bch_types_1 = require("../bch/bch-types");
const instruction_sets_utils_1 = require("../instruction-sets-utils");
const combinators_1 = require("./combinators");
const common_1 = require("./common");
const encoding_1 = require("./encoding");
const errors_1 = require("./errors");
const flow_control_1 = require("./flow-control");
const opcodes_1 = require("./opcodes");
const signing_serialization_1 = require("./signing-serialization");
exports.opRipemd160 = ({ ripemd160, }) => (state) => combinators_1.useOneStackItem(state, (nextState, [value]) => combinators_1.pushToStack(nextState, ripemd160.hash(value)));
exports.opSha1 = ({ sha1, }) => (state) => combinators_1.useOneStackItem(state, (nextState, [value]) => combinators_1.pushToStack(nextState, sha1.hash(value)));
exports.opSha256 = ({ sha256, }) => (state) => combinators_1.useOneStackItem(state, (nextState, [value]) => combinators_1.pushToStack(nextState, sha256.hash(value)));
exports.opHash160 = ({ ripemd160, sha256, }) => (state) => combinators_1.useOneStackItem(state, (nextState, [value]) => combinators_1.pushToStack(nextState, ripemd160.hash(sha256.hash(value))));
exports.opHash256 = ({ sha256, }) => (state) => combinators_1.useOneStackItem(state, (nextState, [value]) => combinators_1.pushToStack(nextState, sha256.hash(sha256.hash(value))));
exports.opCodeSeparator = () => (state) => {
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.lastCodeSeparator = state.ip;
    return state;
};
exports.opCheckSig = ({ flags, secp256k1, sha256, }) => (s) => 
// eslint-disable-next-line complexity
combinators_1.useTwoStackItems(s, (state, [bitcoinEncodedSignature, publicKey]) => {
    if (!encoding_1.isValidPublicKeyEncoding(publicKey)) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidPublicKeyEncoding, state);
    }
    if (!encoding_1.isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidSignatureEncoding, state);
    }
    const coveredBytecode = instruction_sets_utils_1.serializeAuthenticationInstructions(state.instructions).subarray(state.lastCodeSeparator + 1);
    const { signingSerializationType, signature } = encoding_1.decodeBitcoinSignature(bitcoinEncodedSignature);
    const serialization = signing_serialization_1.generateSigningSerializationBCH({
        correspondingOutput: state.correspondingOutput,
        coveredBytecode,
        locktime: state.locktime,
        outpointIndex: state.outpointIndex,
        outpointTransactionHash: state.outpointTransactionHash,
        outputValue: state.outputValue,
        sequenceNumber: state.sequenceNumber,
        sha256,
        signingSerializationType,
        transactionOutpoints: state.transactionOutpoints,
        transactionOutputs: state.transactionOutputs,
        transactionSequenceNumbers: state.transactionSequenceNumbers,
        version: state.version,
    });
    const digest = sha256.hash(sha256.hash(serialization));
    const useSchnorr = signature.length === bch_types_1.ConsensusBCH.schnorrSignatureLength;
    const success = useSchnorr
        ? secp256k1.verifySignatureSchnorr(signature, publicKey, digest)
        : secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
    return !success &&
        flags.requireNullSignatureFailures &&
        signature.length !== 0
        ? errors_1.applyError(errors_1.AuthenticationErrorCommon.nonNullSignatureFailure, state)
        : combinators_1.pushToStack(state, common_1.booleanToScriptNumber(success));
});
exports.opCheckMultiSig = ({ flags: { requireMinimalEncoding, requireBugValueZero, requireNullSignatureFailures, }, secp256k1, sha256, }) => (s) => combinators_1.useOneScriptNumber(s, (state, publicKeysValue) => {
    const potentialPublicKeys = Number(publicKeysValue);
    if (potentialPublicKeys < 0) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidNaturalNumber, state);
    }
    if (potentialPublicKeys > 20 /* maximumPublicKeys */) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.exceedsMaximumMultisigPublicKeyCount, state);
    }
    const publicKeys = 
    // eslint-disable-next-line functional/immutable-data
    potentialPublicKeys > 0 ? state.stack.splice(-potentialPublicKeys) : [];
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.operationCount += potentialPublicKeys;
    return state.operationCount > common_1.ConsensusCommon.maximumOperationCount
        ? errors_1.applyError(errors_1.AuthenticationErrorCommon.exceededMaximumOperationCount, state)
        : combinators_1.useOneScriptNumber(state, (nextState, approvingKeys) => {
            const requiredApprovingPublicKeys = Number(approvingKeys);
            if (requiredApprovingPublicKeys < 0) {
                return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidNaturalNumber, nextState);
            }
            if (requiredApprovingPublicKeys > potentialPublicKeys) {
                return errors_1.applyError(errors_1.AuthenticationErrorCommon.insufficientPublicKeys, nextState);
            }
            const signatures = requiredApprovingPublicKeys > 0
                ? // eslint-disable-next-line functional/immutable-data
                    nextState.stack.splice(-requiredApprovingPublicKeys)
                : [];
            return combinators_1.useOneStackItem(nextState, 
            // eslint-disable-next-line complexity
            (finalState, [protocolBugValue]) => {
                if (requireBugValueZero && protocolBugValue.length !== 0) {
                    return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidProtocolBugValue, finalState);
                }
                const coveredBytecode = instruction_sets_utils_1.serializeAuthenticationInstructions(finalState.instructions).subarray(finalState.lastCodeSeparator + 1);
                let approvingPublicKeys = 0; // eslint-disable-line functional/no-let
                let remainingSignatures = signatures.length; // eslint-disable-line functional/no-let
                let remainingPublicKeys = publicKeys.length; // eslint-disable-line functional/no-let
                // eslint-disable-next-line functional/no-loop-statement
                while (remainingSignatures > 0 &&
                    remainingPublicKeys > 0 &&
                    approvingPublicKeys + remainingPublicKeys >=
                        remainingSignatures &&
                    approvingPublicKeys !== requiredApprovingPublicKeys) {
                    const publicKey = publicKeys[remainingPublicKeys - 1];
                    const bitcoinEncodedSignature = signatures[remainingSignatures - 1];
                    if (!encoding_1.isValidPublicKeyEncoding(publicKey)) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidPublicKeyEncoding, finalState);
                    }
                    if (!encoding_1.isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidSignatureEncoding, finalState);
                    }
                    const { signingSerializationType, signature, } = encoding_1.decodeBitcoinSignature(bitcoinEncodedSignature);
                    const serialization = signing_serialization_1.generateSigningSerializationBCH({
                        correspondingOutput: state.correspondingOutput,
                        coveredBytecode,
                        locktime: state.locktime,
                        outpointIndex: state.outpointIndex,
                        outpointTransactionHash: state.outpointTransactionHash,
                        outputValue: state.outputValue,
                        sequenceNumber: state.sequenceNumber,
                        sha256,
                        signingSerializationType,
                        transactionOutpoints: state.transactionOutpoints,
                        transactionOutputs: state.transactionOutputs,
                        transactionSequenceNumbers: state.transactionSequenceNumbers,
                        version: state.version,
                    });
                    const digest = sha256.hash(sha256.hash(serialization));
                    if (signature.length === bch_types_1.ConsensusBCH.schnorrSignatureLength) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.schnorrSizedSignatureInCheckMultiSig, finalState);
                    }
                    const signed = secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
                    // eslint-disable-next-line functional/no-conditional-statement
                    if (signed) {
                        approvingPublicKeys += 1; // eslint-disable-line functional/no-expression-statement
                        remainingSignatures -= 1; // eslint-disable-line functional/no-expression-statement
                    }
                    remainingPublicKeys -= 1; // eslint-disable-line functional/no-expression-statement
                }
                const success = approvingPublicKeys === requiredApprovingPublicKeys;
                if (!success &&
                    requireNullSignatureFailures &&
                    !signatures.every((signature) => signature.length === 0)) {
                    return errors_1.applyError(errors_1.AuthenticationErrorCommon.nonNullSignatureFailure, finalState);
                }
                return combinators_1.pushToStack(finalState, common_1.booleanToScriptNumber(success));
            });
        }, { requireMinimalEncoding });
}, { requireMinimalEncoding });
exports.opCheckSigVerify = ({ flags, secp256k1, sha256, }) => combinators_1.combineOperations(exports.opCheckSig({ flags, secp256k1, sha256 }), flow_control_1.opVerify());
exports.opCheckMultiSigVerify = ({ flags, secp256k1, sha256, }) => combinators_1.combineOperations(exports.opCheckMultiSig({ flags, secp256k1, sha256 }), flow_control_1.opVerify());
exports.cryptoOperations = ({ flags, ripemd160, secp256k1, sha1, sha256, }) => ({
    [opcodes_1.OpcodesCommon.OP_RIPEMD160]: exports.opRipemd160({
        ripemd160,
    }),
    [opcodes_1.OpcodesCommon.OP_SHA1]: exports.opSha1({ sha1 }),
    [opcodes_1.OpcodesCommon.OP_SHA256]: exports.opSha256({ sha256 }),
    [opcodes_1.OpcodesCommon.OP_HASH160]: exports.opHash160({
        ripemd160,
        sha256,
    }),
    [opcodes_1.OpcodesCommon.OP_HASH256]: exports.opHash256({ sha256 }),
    [opcodes_1.OpcodesCommon.OP_CODESEPARATOR]: exports.opCodeSeparator(),
    [opcodes_1.OpcodesCommon.OP_CHECKSIG]: exports.opCheckSig({
        flags,
        secp256k1,
        sha256,
    }),
    [opcodes_1.OpcodesCommon.OP_CHECKSIGVERIFY]: exports.opCheckSigVerify({
        flags,
        secp256k1,
        sha256,
    }),
    [opcodes_1.OpcodesCommon.OP_CHECKMULTISIG]: exports.opCheckMultiSig({
        flags,
        secp256k1,
        sha256,
    }),
    [opcodes_1.OpcodesCommon.OP_CHECKMULTISIGVERIFY]: exports.opCheckMultiSigVerify({ flags, secp256k1, sha256 }),
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9hdXRoL2luc3RydWN0aW9uLXNldHMvY29tbW9uL2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVFBLGdEQUFnRDtBQUNoRCxzRUFBZ0Y7QUFFaEYsK0NBTXVCO0FBQ3ZCLHFDQUFrRTtBQUNsRSx5Q0FJb0I7QUFDcEIscUNBQWlFO0FBQ2pFLGlEQUEwQztBQUMxQyx1Q0FBMEM7QUFDMUMsbUVBQTBFO0FBSTdELFFBQUEsV0FBVyxHQUFHLENBSXpCLEVBQ0EsU0FBUyxHQUdWLEVBQW9CLEVBQUUsQ0FBQyxDQUFDLEtBQVksRUFBRSxFQUFFLENBQ3ZDLDZCQUFlLENBQUMsS0FBSyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUM1Qyx5QkFBVyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQzlDLENBQUM7QUFFUyxRQUFBLE1BQU0sR0FBRyxDQUlwQixFQUNBLElBQUksR0FHTCxFQUFvQixFQUFFLENBQUMsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUN2Qyw2QkFBZSxDQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FDNUMseUJBQVcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUN6QyxDQUFDO0FBRVMsUUFBQSxRQUFRLEdBQUcsQ0FJdEIsRUFDQSxNQUFNLEdBS1AsRUFBb0IsRUFBRSxDQUFDLENBQUMsS0FBWSxFQUFFLEVBQUUsQ0FDdkMsNkJBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQzVDLHlCQUFXLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxD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