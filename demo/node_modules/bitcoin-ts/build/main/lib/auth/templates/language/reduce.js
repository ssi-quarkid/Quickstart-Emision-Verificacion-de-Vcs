"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const format_1 = require("../../../format/format");
const opcodes_1 = require("../../instruction-sets/common/opcodes");
const instruction_sets_1 = require("../../instruction-sets/instruction-sets");
const instruction_sets_utils_1 = require("../../instruction-sets/instruction-sets-utils");
const pluckStartPosition = (range) => ({
    startColumn: range.startColumn,
    startLineNumber: range.startLineNumber,
});
const pluckEndPosition = (range) => ({
    endColumn: range.endColumn,
    endLineNumber: range.endLineNumber,
});
const mergeRanges = (ranges) => {
    const unsortedMerged = ranges.reduce(
    // eslint-disable-next-line complexity
    (merged, range) => (Object.assign(Object.assign({}, (range.startLineNumber < merged.startLineNumber
        ? pluckStartPosition(range)
        : range.startLineNumber === merged.startLineNumber &&
            range.startColumn < merged.startColumn
            ? pluckStartPosition(range)
            : pluckStartPosition(merged))), (range.endLineNumber > merged.endLineNumber
        ? pluckEndPosition(range)
        : range.endLineNumber === merged.endLineNumber &&
            range.endColumn > merged.endColumn
            ? pluckEndPosition(range)
            : pluckEndPosition(merged)))), ranges[0]);
    return Object.assign(Object.assign({}, pluckStartPosition(unsortedMerged)), pluckEndPosition(unsortedMerged));
};
const emptyReductionTraceNode = (range) => ({
    bytecode: Uint8Array.of(),
    range,
});
/**
 * Aggregate instructions to build groups of non-malformed instructions.
 */
// eslint-disable-next-line complexity
const aggregatedParseReductionTraceNodes = (nodes) => {
    const aggregations = [];
    // eslint-disable-next-line functional/no-let
    let ip = 0;
    // eslint-disable-next-line functional/no-let, init-declarations
    let incomplete;
    // eslint-disable-next-line functional/no-loop-statement
    for (const node of nodes) {
        const bytecode = incomplete === undefined
            ? node.bytecode
            : format_1.flattenBinArray([incomplete.bytecode, node.bytecode]);
        const range = incomplete === undefined
            ? node.range
            : mergeRanges([incomplete.range, node.range]);
        // eslint-disable-next-line functional/no-expression-statement
        incomplete = undefined;
        const parsed = instruction_sets_utils_1.parseBytecode(bytecode);
        // eslint-disable-next-line functional/no-conditional-statement
        if (parsed.length === 0) {
            // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
            aggregations.push({
                instructions: [],
                lastIp: ip,
                range,
            });
            // eslint-disable-next-line functional/no-conditional-statement
        }
        else if (instruction_sets_utils_1.authenticationInstructionsAreNotMalformed(parsed)) {
            // eslint-disable-next-line functional/no-expression-statement
            ip += parsed.length;
            // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
            aggregations.push({
                instructions: parsed,
                lastIp: ip,
                range,
            });
            // eslint-disable-next-line functional/no-conditional-statement
        }
        else {
            // eslint-disable-next-line functional/no-expression-statement
            incomplete = { bytecode, range };
        }
    }
    return Object.assign({ aggregations, success: true }, (incomplete === undefined
        ? undefined
        : {
            remainingBytecode: incomplete.bytecode,
            remainingRange: incomplete.range,
            success: false,
        }));
};
/**
 * Evaluate an array of `InstructionAggregation`s with the provided
 * `AuthenticationVirtualMachine`, matching the results back to their source
 * ranges.
 */
exports.evaluateInstructionAggregations = (aggregations, 
// eslint-disable-next-line @typescript-eslint/no-explicit-any
vm, getState) => {
    var _a, _b;
    const nonEmptyAggregations = aggregations.filter((aggregation) => aggregation.instructions.length > 0);
    const evaluationPlan = nonEmptyAggregations.reduce((plan, aggregation) => {
        const instructions = [...plan.instructions, ...aggregation.instructions];
        return {
            breakpoints: [
                ...plan.breakpoints,
                { ip: aggregation.lastIp, range: aggregation.range },
            ],
            instructions,
        };
    }, { breakpoints: [], instructions: [] });
    const trace = vm.stateDebug(getState(evaluationPlan.instructions));
    const samples = evaluationPlan.breakpoints.map((breakpoint) => ({
        range: breakpoint.range,
        state: trace[breakpoint.ip - 1],
    }));
    const firstInvalidSample = samples.findIndex((sample) => sample.state === undefined);
    const errorSample = (_a = samples[firstInvalidSample - 1]) !== null && _a !== void 0 ? _a : samples[firstInvalidSample];
    return errorSample === undefined
        ? {
            samples: samples,
            success: true,
        }
        : {
            errors: [
                {
                    error: errorSample.state === undefined
                        ? `Failed to reduce evaluation: vm.debug produced no valid program states.`
                        : `Failed to reduce evaluation: ${(_b = errorSample.state.error) !== null && _b !== void 0 ? _b : 'unknown error'}`,
                    range: errorSample.range,
                },
            ],
            samples,
            success: false,
        };
};
/**
 * Incrementally evaluate an array of `ScriptReductionTraceNode`s, returning a
 * trace of the evaluation and the resulting top stack item (`evaluationResult`)
 * if successful.
 *
 * @param nodes - an array of reduced nodes
 * @param vm - the `AuthenticationVirtualMachine` to use in the evaluation
 * @param getState - a method which should generate a new ProgramState given an
 * array of `instructions`
 */
// eslint-disable-next-line complexity
exports.sampledEvaluateReductionTraceNodes = (nodes, 
// eslint-disable-next-line @typescript-eslint/no-explicit-any
vm, getState) => {
    const parsed = aggregatedParseReductionTraceNodes(nodes);
    const evaluated = exports.evaluateInstructionAggregations(parsed.aggregations, vm, getState);
    if (parsed.success && evaluated.success) {
        const samples = evaluated.samples.length > 0
            ? evaluated.samples
            : [{ range: parsed.aggregations[0].range, state: getState([]) }];
        const lastSample = samples[samples.length - 1];
        const lastStackItem = lastSample.state.stack[lastSample.state.stack.length - 1];
        const evaluationResult = lastStackItem === undefined ? Uint8Array.of() : lastStackItem.slice();
        return {
            bytecode: evaluationResult,
            samples,
            success: true,
        };
    }
    return {
        bytecode: Uint8Array.of(),
        errors: [
            ...(parsed.success
                ? []
                : [
                    {
                        error: `A sample is malformed and cannot be evaluated: ${instruction_sets_utils_1.disassembleBytecode(opcodes_1.OpcodesCommon, parsed.remainingBytecode)}`,
                        range: parsed.remainingRange,
                    },
                ]),
            ...(evaluated.success ? [] : evaluated.errors),
        ],
        samples: evaluated.samples,
        success: false,
    };
};
/**
 * This method will throw an error if provided a `compiledScript` with
 * compilation errors. To check for compilation errors, use `getCompileErrors`.
 * @param compiledScript - the `CompiledScript` to reduce
 * @param vm - the `AuthenticationVirtualMachine` to use for evaluations
 * @param createState - a method which returns the base `ProgramState` used when initializing evaluations
 */
exports.reduceScript = (compiledScript, 
// eslint-disable-next-line @typescript-eslint/no-explicit-any
vm, createState) => {
    const source = compiledScript.map((segment) => {
        switch (segment.type) {
            case 'bytecode':
                return { bytecode: segment.value, range: segment.range };
            case 'push': {
                if (segment.value.length === 0) {
                    return emptyReductionTraceNode(segment.range);
                }
                const push = exports.reduceScript(segment.value, vm, createState);
                const bytecode = instruction_sets_1.encodeDataPush(push.bytecode);
                return Object.assign(Object.assign({ bytecode }, (push.errors === undefined ? undefined : { errors: push.errors })), { range: segment.range, source: [push] });
            }
            case 'evaluation': {
                if (segment.value.length === 0) {
                    return emptyReductionTraceNode(segment.range);
                }
                if (typeof vm === 'undefined' || typeof createState === 'undefined') {
                    return Object.assign({ errors: [
                            {
                                error: 'Both a VM and a createState method are required to reduce evaluations.',
                                range: segment.range,
                            },
                        ] }, emptyReductionTraceNode(segment.range));
                }
                const reductionTrace = exports.reduceScript(segment.value, vm, createState);
                const evaluated = exports.sampledEvaluateReductionTraceNodes(reductionTrace.source, vm, createState);
                const errors = [
                    ...(reductionTrace.errors === undefined ? [] : reductionTrace.errors),
                    ...(evaluated.success ? [] : evaluated.errors),
                ];
                return Object.assign(Object.assign({}, (errors.length > 0
                    ? Object.assign({ errors }, emptyReductionTraceNode(segment.range)) : {
                    bytecode: evaluated.bytecode,
                    range: segment.range,
                })), { samples: evaluated.samples, source: [reductionTrace] });
            }
            case 'comment':
                return emptyReductionTraceNode(segment.range);
            case 'error':
                return Object.assign({ errors: [
                        {
                            error: `Tried to reduce a BTL script with resolution errors: ${segment.value}`,
                            range: segment.range,
                        },
                    ] }, emptyReductionTraceNode(segment.range));
            default:
                return new Error(
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                `"${segment.type}" is not a known segment type.`);
        }
    });
    const reduction = source.reduce((all, segment) => (Object.assign({ bytecode: [...all.bytecode, segment.bytecode], ranges: [...all.ranges, segment.range] }, (all.errors !== undefined || segment.errors !== undefined
        ? {
            errors: [
                ...(all.errors === undefined ? [] : all.errors),
                ...(segment.errors === undefined ? [] : segment.errors),
            ],
        }
        : undefined))), { bytecode: [], ranges: [] });
    return Object.assign(Object.assign({}, (reduction.errors === undefined
        ? undefined
        : { errors: reduction.errors })), { bytecode: format_1.flattenBinArray(reduction.bytecode), range: mergeRanges(reduction.ranges), source });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9hdXRoL3RlbXBsYXRlcy9sYW5ndWFnZS9yZWR1Y2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxtREFBeUQ7QUFDekQsbUVBQXNFO0FBQ3RFLDhFQUF5RTtBQUV6RSwwRkFJdUQ7QUFPdkQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEtBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM1QyxXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVc7SUFDOUIsZUFBZSxFQUFFLEtBQUssQ0FBQyxlQUFlO0NBQ3ZDLENBQUMsQ0FBQztBQUVILE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDMUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO0lBQzFCLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtDQUNuQyxDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQWUsRUFBRSxFQUFFO0lBQ3RDLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxNQUFNO0lBQ2xDLHNDQUFzQztJQUN0QyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLGlDQUNkLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsZUFBZTtRQUNoRCxDQUFDLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDO1FBQzNCLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxLQUFLLE1BQU0sQ0FBQyxlQUFlO1lBQ2hELEtBQUssQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVc7WUFDeEMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztZQUMzQixDQUFDLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsR0FDNUIsQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxhQUFhO1FBQzVDLENB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