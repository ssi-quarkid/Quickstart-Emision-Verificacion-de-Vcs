{"version":3,"file":"did-key-common.cjs.development.js","sources":["../src/types/index.ts","../src/Jws/index.ts","../src/getResolver.ts","../src/getGet.ts"],"sourcesContent":["/* class decorator */\nexport const staticImplements = <T>() => {\n  return <U extends T>(constructor: U) => {\n    return constructor;\n  };\n};\n\nexport * from './JWE_ALG';\nexport * from './JWS_ALG';\n\nexport * from './KeyPairClass';\nexport * from './KeyPairInstance';\nexport * from './KeyAgreementKeyPairClass';\nexport * from './KeyPairGenerateOptions';\nexport * from './EpkResult';\nexport * from './KeyEncryptionKeyFromEphemeralPublicKeyOptions';\nexport * from './KeyEncryptionKeyFromStaticPublicKeyOptions';\nexport * from './DeriveSecretOptions';\n\nexport * from './KeyPairBase';\n\nexport * from './KeyPairJwk';\nexport * from './JsonWebKeyPair';\n\nexport * from './KeyPairBase58';\nexport * from './LinkedDataKeyPair';\n\nexport * from './KeyAgreementKeyPairInstance';\n","import base64url from 'base64url';\nimport canonicalize from 'canonicalize';\n\nexport const createJws = async (signer: any, payload: any, header: object) => {\n  const encodedHeader = base64url.encode(canonicalize(header));\n  const encodedPayload = base64url.encode(canonicalize(payload));\n  const toBeSigned = `${encodedHeader}.${encodedPayload}`;\n  const signature = await signer.sign(Buffer.from(toBeSigned));\n  return `${toBeSigned}.${base64url.encode(Buffer.from(signature))}`;\n};\n\nexport const verifyJws = async (verifier: any, jws: string) => {\n  const [header, payload, signature] = jws.split('.');\n  const toBeVerified = `${header}.${payload}`;\n  const verified = await verifier.verify(\n    Buffer.from(toBeVerified),\n    base64url.toBuffer(signature)\n  );\n\n  return verified;\n};\n\nexport const createDetachedJws = async (\n  signer: any,\n  payload: Buffer,\n  header: object\n) => {\n  const encodedHeader = base64url.encode(\n    canonicalize({ ...header, b64: false, crit: ['b64'] })\n  );\n\n  const toBeSigned = new Uint8Array(\n    Buffer.concat([\n      Buffer.from(encodedHeader, 'utf-8'),\n      Buffer.from('.', 'utf-8'),\n      payload,\n    ])\n  );\n  const signature = await signer.sign(Buffer.from(toBeSigned));\n  const encodedSignature = base64url.encode(Buffer.from(signature));\n  return `${encodedHeader}..${encodedSignature}`;\n};\n\nexport const verifyDetachedJws = async (\n  verifier: any,\n  payload: Buffer,\n  signature: string\n) => {\n  const [encodedHeader, encodedSignature] = signature.split('..');\n\n  const toBeVerified = new Uint8Array(\n    Buffer.concat([\n      Buffer.from(encodedHeader, 'utf-8'),\n      Buffer.from('.', 'utf-8'),\n      payload,\n    ])\n  );\n\n  const verified = await verifier.verify(\n    Buffer.from(toBeVerified),\n    base64url.toBuffer(encodedSignature)\n  );\n\n  return verified;\n};\n","const cbor = require('borc');\n\nexport const getVerificationMethod = (\n  instance: any,\n  contentType: string = 'application/did+ld+json'\n) => {\n  switch (contentType) {\n    case 'application/did+json': {\n      return instance.toJsonWebKeyPair();\n    }\n    case 'application/did+cbor': {\n      return instance.toJsonWebKeyPair();\n    }\n    case 'application/did+ld+json': {\n      return instance.toKeyPair();\n    }\n  }\n  throw new Error(\n    'This implementation of did:key does not support: ' + contentType\n  );\n};\n\nconst supportedContentTypes = [\n  'application/did+json',\n  'application/did+ld+json',\n  'application/did+cbor',\n];\n\nexport const keyToDidDoc = async (\n  didKeyPairInstance: any,\n  contentType: string = 'application/did+ld+json'\n) => {\n  if (supportedContentTypes.indexOf(contentType) === -1) {\n    throw new Error('Unsupported DID Document representation. ' + contentType);\n  }\n  const did = `did:key:${didKeyPairInstance.fingerprint()}`;\n  const externalKeyRepresentation = getVerificationMethod(\n    didKeyPairInstance,\n    contentType\n  );\n  let verificationRelationships: any = {\n    verificationMethod: [externalKeyRepresentation],\n  };\n\n  if (didKeyPairInstance.verifier) {\n    verificationRelationships = {\n      ...verificationRelationships,\n      authentication: [externalKeyRepresentation.id],\n      assertionMethod: [externalKeyRepresentation.id],\n      capabilityInvocation: [externalKeyRepresentation.id],\n      capabilityDelegation: [externalKeyRepresentation.id],\n    };\n  }\n\n  if (didKeyPairInstance.deriveSecret) {\n    verificationRelationships = {\n      ...verificationRelationships,\n      keyAgreement: [externalKeyRepresentation.id],\n    };\n  }\n\n  if (didKeyPairInstance.type === 'Ed25519VerificationKey2018') {\n    const kek = await didKeyPairInstance.toX25519KeyPair(false);\n    const externalKeyRepresentation2 = getVerificationMethod(kek, contentType);\n    verificationRelationships = {\n      ...verificationRelationships,\n      verificationMethod: [\n        ...verificationRelationships.verificationMethod,\n        externalKeyRepresentation2,\n      ],\n      keyAgreement: [externalKeyRepresentation2.id],\n    };\n  }\n  const didDocument = {\n    '@context': [\n      'https://www.w3.org/ns/did/v1',\n      'https://ns.did.ai/transmute/v1',\n      {\n        '@base': did,\n      },\n    ],\n    id: did,\n    ...verificationRelationships,\n  };\n\n  return didDocument;\n};\n\n// resolve ( did, did-resolution-input-metadata )\n//      -> ( did-resolution-metadata, did-document, did-document-metadata )\nexport const getResolve = (DidKeyPairClass: any) => {\n  const resolve = async (\n    didUri: string,\n    resolutionMetaData: any = { accept: 'application/did+ld+json' }\n  ) => {\n    const fingerprint = didUri\n      .split('#')[0]\n      .split('did:key:')\n      .pop();\n    const publicKey = await DidKeyPairClass.fromFingerprint({ fingerprint });\n    const didDocument = await keyToDidDoc(publicKey, resolutionMetaData.accept);\n\n    const didResolutionResponse = {\n      '@context': 'https://w3id.org/did-resolution/v1',\n      didDocument,\n      didDocumentMetadata: {\n        'content-type': resolutionMetaData.accept,\n      },\n      didResolutionMetadata: {},\n    };\n    if (resolutionMetaData.accept === 'application/did+cbor') {\n      return cbor.encode(didResolutionResponse);\n    }\n    return didResolutionResponse;\n  };\n  return resolve;\n};\n","export const getGet = (resolve: any) => {\n  const get = async ({ did, url }: any = {}) => {\n    did = did || url;\n    if (!did) {\n      throw new TypeError('\"did\" must be a string.');\n    }\n    const result = await resolve(did);\n    return result.didDocument;\n  };\n  return get;\n};\n"],"names":["staticImplements","constructor","createJws","signer","payload","header","encodedHeader","base64url","encode","canonicalize","encodedPayload","toBeSigned","sign","Buffer","from","signature","verifyJws","verifier","jws","split","toBeVerified","verify","toBuffer","createDetachedJws","b64","crit","Uint8Array","concat","encodedSignature","verifyDetachedJws","cbor","require","getVerificationMethod","instance","contentType","toJsonWebKeyPair","toKeyPair","Error","supportedContentTypes","keyToDidDoc","didKeyPairInstance","didDocument","did","id","verificationRelationships","indexOf","fingerprint","externalKeyRepresentation","verificationMethod","authentication","assertionMethod","capabilityInvocation","capabilityDelegation","deriveSecret","keyAgreement","type","toX25519KeyPair","kek","externalKeyRepresentation2","getResolve","DidKeyPairClass","resolve","didUri","resolutionMetaData","accept","pop","fromFingerprint","publicKey","didResolutionResponse","didDocumentMetadata","didResolutionMetadata","getGet","get","url","TypeError","result"],"mappings":"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"}