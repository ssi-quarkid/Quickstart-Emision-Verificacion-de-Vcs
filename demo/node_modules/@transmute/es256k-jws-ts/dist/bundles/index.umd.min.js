!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("tslib"),require("base64url"),require("bitcoin-ts"),require("crypto"),require("@trust/keyto"),require("json-stringify-deterministic")):"function"==typeof define&&define.amd?define(["exports","tslib","base64url","bitcoin-ts","crypto","@trust/keyto","json-stringify-deterministic"],t):t((e=e||self).Es256kJwsTs={},e.tslib,e.base64url,e.BitcoinTS,e.crypto,e.keyto,e.stringify)}(this,function(e,h,g,p,b,a,i){"use strict";g=g&&g.hasOwnProperty("default")?g.default:g,b=b&&b.hasOwnProperty("default")?b.default:b,a=a&&a.hasOwnProperty("default")?a.default:a,i=i&&i.hasOwnProperty("default")?i.default:i;var s=function(e){var t=h.__assign({},e);delete t.d,delete t.kid,delete t.alg;var r=b.createHash("sha256").update(i(t)).digest();return g.encode(Buffer.from(r))},n=function(t){return h.__awaiter(void 0,void 0,void 0,function(){return h.__generator(this,function(e){return[2,a.from(h.__assign(h.__assign({},t),{crv:"K-256"}),"jwk").toString("blk","private")]})})},o=function(n){return h.__awaiter(void 0,void 0,void 0,function(){var t,r,i;return h.__generator(this,function(e){switch(e.label){case 0:return[4,p.instantiateSecp256k1()];case 1:return t=e.sent(),r=a.from(h.__assign(h.__assign({},n),{crv:"K-256"}),"jwk").toString("blk","public"),i=t.compressPublicKey(p.hexToBin(r)),[2,p.binToHex(i)]}})})},w=function(r){return h.__awaiter(void 0,void 0,void 0,function(){var t;return h.__generator(this,function(e){switch(e.label){case 0:return[4,n(r)];case 1:return t=e.sent(),[2,p.hexToBin(t)]}})})},m=function(r){return h.__awaiter(void 0,void 0,void 0,function(){var t;return h.__generator(this,function(e){switch(e.label){case 0:return[4,o(r)];case 1:return t=e.sent(),[2,p.hexToBin(t)]}})})},t={binToHex:p.binToHex,getKid:s,hexToBin:p.hexToBin,privateJWKFromPrivateKeyHex:function(i){return h.__awaiter(void 0,void 0,void 0,function(){var t,r;return h.__generator(this,function(e){return t=h.__assign(h.__assign({},a.from(i,"blk").toJwk("private")),{crv:"secp256k1"}),r=s(t),[2,h.__assign(h.__assign({},t),{kid:r})]})})},privateJWKFromPrivateKeyPem:function(e){var t=h.__assign(h.__assign({},a.from(e,"pem").toJwk("private")),{crv:"secp256k1"}),r=s(t);return h.__assign(h.__assign({},t),{kid:r})},privateKeyHexFromJWK:n,privateKeyUInt8ArrayFromJWK:w,publicJWKFromPublicKeyHex:function(o){return h.__awaiter(void 0,void 0,void 0,function(){var t,r,i,n;return h.__generator(this,function(e){switch(e.label){case 0:return[4,p.instantiateSecp256k1()];case 1:return t=e.sent(),66===(r=o).length&&(r=p.binToHex(t.uncompressPublicKey(p.hexToBin(o)))),i=h.__assign(h.__assign({},a.from(r,"blk").toJwk("public")),{crv:"secp256k1"}),n=s(i),[2,h.__assign(h.__assign({},i),{kid:n})]}})})},publicJWKFromPublicKeyPem:function(e){var t=h.__assign(h.__assign({},a.from(e,"pem").toJwk("public")),{crv:"secp256k1"}),r=s(t);return h.__assign(h.__assign({},t),{kid:r})},publicKeyHexFromJWK:o,publicKeyUInt8ArrayFromJWK:m},y=function(r){function e(e){var t=r.call(this,e)||this;return t.name="JWSVerificationFailed",t}return h.__extends(e,r),e}(Error),u={decode:function(e,t){void 0===t&&(t={complete:!1});var r=e.split("."),i=r[0],n=r[1],o=r[2];return t.complete?{header:JSON.parse(g.decode(i)),payload:JSON.parse(g.decode(n)),signature:o}:JSON.parse(g.decode(n))},sign:function(_,v,l){return void 0===l&&(l={alg:"ES256K"}),h.__awaiter(void 0,void 0,void 0,function(){var t,r,i,n,o,a,s,u,c,f,d;return h.__generator(this,function(e){switch(e.label){case 0:return[4,w(v)];case 1:return t=e.sent(),[4,p.instantiateSecp256k1()];case 2:return r=e.sent(),i=g.encode(JSON.stringify(l)),n=g.encode(JSON.stringify(_)),o=i+"."+n,a=Buffer.from(o),s=b.createHash("sha256").update(a).digest().toString("hex"),u=p.hexToBin(s),c=r.signMessageHashCompact(t,u),f=p.binToHex(c),d=g.encode(Buffer.from(f,"hex")),[2,i+"."+n+"."+d]}})})},signDetached:function(d,_,v){return void 0===v&&(v={alg:"ES256K",b64:!1,crit:["b64"]}),h.__awaiter(void 0,void 0,void 0,function(){var t,r,i,n,o,a,s,u,c,f;return h.__generator(this,function(e){switch(e.label){case 0:return[4,w(_)];case 1:return t=e.sent(),[4,p.instantiateSecp256k1()];case 2:return r=e.sent(),i=g.encode(JSON.stringify(v)),n=Buffer.concat([Buffer.from(i+".","utf8"),Buffer.from(d.buffer,d.byteOffset,d.length)]),o=Buffer.from(n),a=b.createHash("sha256").update(o).digest().toString("hex"),s=p.hexToBin(a),u=r.signMessageHashCompact(t,s),c=p.binToHex(u),f=g.encode(Buffer.from(c,"hex")),[2,i+".."+f]}})})},verify:function(_,v){return h.__awaiter(void 0,void 0,void 0,function(){var t,r,i,n,o,a,s,u,c,f,d;return h.__generator(this,function(e){switch(e.label){case 0:return[4,p.instantiateSecp256k1()];case 1:return t=e.sent(),[4,m(v)];case 2:if(r=e.sent(),i=_.split("."),n=i[0],o=i[1],a=i[2],s=n+"."+o,u=Buffer.from(s),c=b.createHash("sha256").update(u).digest().toString("hex"),f=p.hexToBin(c),d=p.hexToBin(g.toBuffer(a).toString("hex")),t.verifySignatureCompact(d,r,f))return[2,JSON.parse(g.decode(o))];throw new y("signature verification failed")}})})},verifyDetached:function(_,v,l){return h.__awaiter(void 0,void 0,void 0,function(){var t,r,i,n,o,a,s,u,c,f,d;return h.__generator(this,function(e){switch(e.label){case 0:if(-1===_.indexOf(".."))throw new y("not a valid rfc7797 jws.");if(t=_.split(".."),r=t[0],i=t[1],"ES256K"!==(n=JSON.parse(g.decode(r))).alg)throw new Error("JWS alg is not signed with ES256K.");if(!1!==n.b64||!n.crit||!n.crit.length||"b64"!==n.crit[0])throw new Error("JWS Header is not in rfc7797 format (not detached).");return[4,m(l)];case 1:return o=e.sent(),[4,p.instantiateSecp256k1()];case 2:if(a=e.sent(),s=Buffer.concat([Buffer.from(r+".","utf8"),Buffer.from(v.buffer,v.byteOffset,v.length)]),u=Buffer.from(s),c=b.createHash("sha256").update(u).digest().toString("hex"),f=p.hexToBin(c),d=p.hexToBin(g.toBuffer(i).toString("hex")),a.verifySignatureCompact(d,o,f))return[2,!0];throw new Error("Cannot verify detached signature.")}})})}},c=function(r){function e(e){var t=r.call(this,e)||this;return t.name="JWTVerificationFailed",t}return h.__extends(e,r),e}(Error),r={sign:function(i,n){return h.__awaiter(void 0,void 0,void 0,function(){var t,r;return h.__generator(this,function(e){return t=Math.floor(Date.now()/1e3),r=t+3600,[2,u.sign(h.__assign(h.__assign({},i),{exp:i.exp||r,iat:t}),n,{alg:"ES256K",kid:n.kid})]})})},decode:u.decode,verify:function(r,i){return h.__awaiter(void 0,void 0,void 0,function(){var t;return h.__generator(this,function(e){switch(e.label){case 0:return[4,u.verify(r,i)];case 1:if(t=e.sent(),Math.floor(Date.now()/1e3)>t.exp)throw new c("token is expired");return[2,t]}})})}};e.JWS=u,e.JWT=r,e.keyUtils=t,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map
